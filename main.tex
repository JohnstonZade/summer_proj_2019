\documentclass[12pt,letterpaper]{article}
\usepackage{fullpage}
\usepackage[top=2cm, bottom=4.5cm, left=2.5cm, right=2.5cm]{geometry}
\usepackage{amsmath,amsthm,amsfonts,amssymb,amscd}
\usepackage{lastpage}
\usepackage{enumerate}
\usepackage{fancyhdr}
\usepackage{mathrsfs}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{hyperref}
\usepackage[nodayofweek, level]{datetime}
\usepackage{bbm}
\usepackage{cases}
\usepackage{esint}

\setlength{\parindent}{0.0in}
\setlength{\parskip}{0.05in}

\usepackage{subcaption}
\usepackage{bold-extra}
\usepackage{epigraph}

\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,
    urlcolor=blue,
    pdftitle={Sharelatex Example},
    pdfpagemode=FullScreen,
    }

%% ----- COMMANDS -----
% Headings
\newcommand\course{Project Writeup}
\newcommand{\theorem}[1]{\underline{\textbf{#1}} \\}
\newcommand{\mybox}[1]{\noindent\fbox{\parbox{\textwidth}{#1}}}

% Notation
\newcommand{\set}[1]{\{#1\}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\BXi}{\boldsymbol{\xi}}
\newcommand{\BNu}{\boldsymbol{\nu}}
\newcommand{\BX}{\boldsymbol{x}}
\newcommand{\BU}{\boldsymbol{u}}
\newcommand{\inv}{^{-1}}
\newcommand{\modulo}[1]{\text{ mod }#1}
\newcommand{\kernel}[1]{\text{ker }#1}
\newcommand{\LeftImplies}{\underline{$\Leftarrow$:} }
\newcommand{\RightImplies}{\underline{$\Rightarrow$:} }
\newcommand{\cycle}[1]{\langle #1 \rangle}
\newcommand{\B}[1]{\mathbf{#1}}

\pagestyle{fancyplain}
\headheight 35pt
\rhead{\course}
\lfoot{}
\cfoot{}
\headsep 1.5em

\fancypagestyle{firststyle}
{
  \fancyhf{}
  \headheight 35pt
  \chead{\textbf{\Large Turbulence in Plasma}} % Edit for title
  \rhead{Zade Johnston \\ \course}
  \lfoot{}
  \cfoot{}
  \headsep 1.5em
}

\graphicspath{{./images/}}

\begin{document}

  \thispagestyle{firststyle}
  \section*{Week 1: 11 Nov - 13 Nov}

  Started this week learning about how to use MPI in Athena++. Followed the \href{https://github.com/PrincetonUniversity/athena-public-version/wiki/Running-3D-MHD-with-OpenMP-and-MPI}{3D blast wave tutorial} and managed to get it working on Thunderbird with HDF5. Jono also recommended learning a text editor, so I spent an hour learning the basics of Vim. \textbf{Note:} HDF5 is better to use than .vtk with parallel computing as it allows all the processors being used to write the data in one file compared to a file for each processor that need to be joined (less hassle).

  Jono then gave me an Athena++ hydrodynamic turbulence input script to play around with, and some MATLAB scripts that analyse the energy spectrum of the fluid in question. At the moment, we model the fluid in a cube. There are two different modes that we're wanting to focus on: decaying turbulence (disturb the fluid initially then leave it to its own devices) and continuously driven turbulence. Ran the Athena++ code with 3 different grid sizes for both modes; see screenshots below.

  \begin{figure}[!h]
   \centering
  \begin{subfigure}{0.3\textwidth}
  \includegraphics[width=0.9\linewidth, height=0.9\linewidth]{Wk1/32_forced_rho.png}
  \caption{Grid Size: 32}
  \label{fig:32rho}
  \end{subfigure}
  \begin{subfigure}{0.3\textwidth}
  \includegraphics[width=0.9\linewidth, height=0.9\linewidth]{Wk1/64_forced_rho.png}
  \caption{Grid Size: 64}
  \label{fig:64rho}
  \end{subfigure}
  \begin{subfigure}{0.3\textwidth}
  \includegraphics[width=0.9\linewidth, height=0.9\linewidth]{Wk1/128_forced_rho.png}
  \caption{Grid Size: 128}
  \label{fig:128rho}
  \end{subfigure}

  \caption{Face-on view of the 3D forced turbulence simulations with different grid sizes; density plotted}
  \label{fig:forcedturb}
  \end{figure}

  These were just the simulations with none of the parameters changed in the input script. Using the MATLAB scripts I also obtained the energy spectrum of the fluid; was very rough due to the low resolution. Wanted to try start a $256^3$ grid size simulation before I left on Wednesday but didn't have enough time to set up; will try again later. Thursday and Friday of this week were spent at the \href{https://otagocarpentries.github.io/2019-11-14-otago/}{Otago Software Carpentry Workshop}.

  \textbf{Next Week:} Play around with parameters. Want to run the larger grid size simulations to obtain a better energy spectrum that fits the $k^{-5/3}$ law, will add screenshots of spectrum then. Plot the total energy over time for both modes; should observe fluctuations in the energy for forced turbulence.


  \section*{Week 2: 18 Nov - 22 Nov}
  This week I ran bigger simulations for both decay and forced turbulence from last week in order to be able to plot the energy spectrum and time evolution. The grid size ranged from 32 to 256, and runs over 30 seconds. All simulations left the parameters in \verb|athinput.turb| unchanged.

  Calculated the turnover time $\tau \sim L/u_l$ of eddies on the scale of the box to get an idea of the timescales involved in the energy cascade. This is important in the decaying case as all the input energy dissipates within a few turnover times, so this allowed me to get an approximate time range to average the energy spectrum over. For the decay simulations I used $L=1$ and $u_L = \sqrt{u^2_x+u^2_y+u^2_z}$ taken at the start of the simulation; for the continuous simulations the average turnover time in the saturated state was used. The data was gotten from the \verb|Turb.hst| file.

  \textbf{Continuous Forcing:} For the continously forced case, the 256 grid size gave the best result. This is expected as it is able to simulate smaller scale eddies compared to lower resolution simulations, allowing more of the energy cascade to be observed. We see that the energy spectrum does follow the $k^{-5/3}$ law (shown in Fig. \ref{fig:256contspec}) for a given range of wavevectors.

  The energy evolution (Fig. \ref{fig:256conteng}) shows an increase in kinetic energy until it levels out after a few turnover times. This leveling out is due to the energy dissipation rate matching the energy input rate from the forcing. There is still some variation around the mean value, which arises from fluctuations due to turbulence.

  \begin{figure}[!h]
   \centering
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth, height=\linewidth]{Wk2/cont_turb_256_default.png}
  \caption{Averaged Spectrum}
  \label{fig:256contspec}
  \end{subfigure}
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth, height=\linewidth]{Wk2/cont_turb_256_default_energy.png}
  \caption{Energy Evolution}
  \label{fig:256conteng}
  \end{subfigure}

  \caption{Plots showing the energy spectrum and time evolution of the 256 grid size continuous forcing simulation}
  \label{fig:256contenergy}
  \end{figure}

  \textbf{Decay:} The energy spectrum (Fig \ref{fig:128decayspec}), averaged over the first two turnover cycles, is not as well defined as the continuous case. I think this is because the energy depends on time instead of being approximately constant. The energy evolution (Fig. \ref{fig:128decayeng}) shows that the total kinetic energy decreases over time due to dissipation from viscosity.

  For the spectrum evolution (Figure \ref{fig:128decayevo}) I took snapshots of the spectrum at 3 second intervals, with a snapshot at 0.1 seconds to observe the energy input (the curve sharply peaked at $k \sim 10$). We see that the energy cascades down through the length scales directly after input (at 6 seconds), and then decreases as it is dissipated as heat at the micro scale (shown by the ``sinking" of the spectrum). This is expected as we saw that the total energy in Fig. \ref{fig:128decayeng} is decreasing.

  \begin{figure}[!h]

  \begin{subfigure}{0.2\linewidth}
  \centering
  \includegraphics[width=1.5\linewidth]{Wk2/decay_turb_128_default.png}
  \caption{Averaged Spectrum}
  \label{fig:128decayspec}
  \end{subfigure}
  \hfill
  \begin{subfigure}{0.2\linewidth}
  \centering
  \includegraphics[width=1.5\linewidth]{Wk2/decay_turb_128_default_energy.png}
  \caption{Energy Evolution}
  \label{fig:128decayeng}
  \end{subfigure}
  \hfill
  \begin{subfigure}{0.2\linewidth}
  \centering
  \includegraphics[width=1.5\linewidth]{Wk2/decay_turb_128_default_evo.png}
  \caption{Spectrum Evolution}
  \label{fig:128decayevo}
  \end{subfigure}

  \caption{Plots showing the energy spectrum and time evolution of the 128 grid size decay simulation}
  \label{fig:128decayenergy}
  \end{figure}

  The magnetic and thermal energy had no relevance to these simulations; it's just part of the MATLAB script that I forgot to remove.

  I learnt that it's good to run the simulations at different resolutions starting with the lowest as it allows you to get a rough idea of what is going to happen without the expense of computing time. It also helps as you can compare with the model to see whether the configuration used is worth investigating. The higher resolutions could differ as turbulence depends strongly on all length scales in the inertial subrange, which are included in the bigger simulations, but it still helps to see what could happen.

  \newpage
  \section*{Week 3: 25 Nov - 29 Nov}

  Ran the linear wave problem in Athena to observe Alf\'ven waves. The pressure and density of the plasma should be constant as these waves travel, which was observed in the simulation (Fig. \ref{fig:linwave}). Alf\'ven waves have the following dispersion relationship:
  $$
    \omega = k_\| v_A
  $$
  where $k_\|$ is the component of the wavevector parallel to the magnetic field and $v_A = B_0 / \sqrt{4\pi \rho}$ is the Alf\'ven velocity at which the waves move, where $B_0$ and $\rho$ are the magnetic field strength and fluid density.

  The linear wave problem has the default settings (I'm not sure about units): $\rho = 1$, $\B{B}_0=(1,\sqrt{2}, 0.5) \implies B_0 = \sqrt{13}/2$. This gives a value for the Alf\'ven velocity of $v_A \approx 0.5086$. The next thing to do is to see whether the wave gives us this value through the dispersion relationship above.

  \begin{figure}[!h]
   \centering
  \begin{subfigure}{0.3\textwidth}
  \includegraphics[width=\linewidth, height=1.1\linewidth]{Wk3/alfvenlinwave_vel.png}
  \caption{Velocity Magnitude}
  \label{fig:linwave_vel}
  \end{subfigure}
  \begin{subfigure}{0.3\textwidth}
  \includegraphics[width=\linewidth, height=1.1\linewidth]{Wk3/alfvenlinwave_press.png}
  \caption{Pressure}
  \label{fig:linwave_press}
  \end{subfigure}
  \begin{subfigure}{0.3\textwidth}
  \includegraphics[width=\linewidth, height=1.1\linewidth]{Wk3/alfvenlinwave_rho.png}
  \caption{Density}
  \label{fig:linwave_rho}
  \end{subfigure}

  \caption{Plots of different properties of the fluid as a linear wave passes through}
  \label{fig:linwave}
  \end{figure}

  I wrote a small Python script to calculate and compare the simulation and theoretical Alf\'ven velocities.
  The angular frequency was calculated by measuring the (simulated) time it took for a peak of the wave to travel through the box, as it has periodic boundary conditions, and dividing this by $2\pi$. The magnitude of the wavevector was gotten by dividing $2\pi$ by the wavelength. All quantities were eyeballed as only a quick check was needed. The result is seen in Fig. \ref{fig:disp_rel}, showing the dispersion relationship holds in the simulation.

  \begin{figure}[!h]
    \centering
    \includegraphics[width=0.6\linewidth]{Wk3/dispersion_rel}
    \caption{Output of the Python script I wrote}
    \label{fig:disp_rel}
  \end{figure}

  \

  \textbf{Questions (answered):}
  \begin{itemize}
    \item Is $\B{k}$ automatically parallel to $\B{B}$ when the \verb|ang_3_vert| variable is set to \verb|True|?

    No, it just rotates the axes such that $\B{k}$ is along the y-axis. Can make it parallel to $\B{B}$ through code.

    \item Why are the density and pressure constant for an Alf\'ven wave?

    Because the Alf\'ven wave is a \textbf{shear wave} i.e. no compression at all. This means $\nabla\cdot\B{u}=0 \implies D\rho/Dt = 0$ i.e. the density is constant in time and thus so is the pressure.

    \item Why is a rectangle used insted of a square for the region of interest?

    Just to make the numbers work out right such that the waves are continuous over the periodic boundaries. Can make it a square if needed.
  \end{itemize}

  The next step was simulating turbulence in the case of MHD. Essentialy the same code was used as the hydrodynamic turbulence case, with a couple of updates to allow for the initialisation of a mean magnetic field in the region of interest.

  In order to get critical balance, we want $u_\perp \sim v_{A0} = B_0/\sqrt{4\pi\rho}$. Athena sets $4\pi\to 1$, so we get $v_{A0} = B_0/\sqrt{\rho}$. We can set $B_0=1$ and $\rho=1$ such that $u_\perp \sim v_{A0}=1$. To do this in the simulation I've set $dE/dt=1$ as this means $u^3_\perp/L \sim 1$ (the box size has $L=1$; letting everything work out to 1 makes it simpler).

  Forgot to add the magnetic field flag so have to redo larger simulations. \textbf{A good check is to look at the first few snapshots in VisIt to see if the magnetic fields (or other parameters) are set up the way I wanted.}

  Trying out Athena's Python codes for plotting and reading data files to help write the \verb|spectrum.m| code in Python. Haven't made much progress yet as I've been focusing on writing the \verb|structure_function.py| code.

  Originally wrote \verb|structure_function.py| using just lists. For 1 million random pairs of points on a $128^3$ continuously forced turbulence grid (non-MHD), the average run time was about 100 seconds. After learning about \verb|numpy| and utilizing this, the same problem had its run time reduced to about 20 seconds; this is a massive improvement. Not sure whether I need to test for a larger number of points. Below in Fig. \ref{fig:structure_plots} I've added the inital output of the function; showing the distribution of distances between the points and the velocity structure function at $t=0.1$ s.

  I've just realised that it doesn't look right in Fig. \ref{fig:structure_plots} as I've used the snapshot in the first 0.1 second after the simulation has begun, so the turbulence will not have fully developed. Will look into more detail next week.

  \begin{figure}[!h]
   \centering
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth]{Wk3/l_dist.png}
  \caption{Distribution of lengths in box}
  \label{fig:l_dist}
  \end{subfigure}
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth]{Wk3/structure_function.png}
  \caption{Velocity Structure Function}
  \label{fig:struct_func}
  \end{subfigure}

  \caption{Output of the structure function code for the hydrodynamic $128^3$ forced turbulence simulation}
  \label{fig:structure_plots}
  \end{figure}

  \newpage
  \section*{Week 4: 2 Dec - 6 Dec}
  After talking with Jono about the structure function code I wrote last week, I updated it such that it generates a log spaced $l$-grid and generates the random points closer together in order to be able to see the finer details in the small $l$ range (inertial subrange). After updating the code we $l$ distribution and structure functions are shown in Fig. \ref{fig:structure_plot_update}. The lengths between the points are now skewed to be smaller which is what was wanted, and the structure function is very close to following Kolmogorov's $l^{2/3}$ rule.

  I've created a \href{https://github.com/JohnstonZade/python_tools}{GitHub repo to hold the Python code that calculates these here}.

  \begin{figure}[!h]
   \centering
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth]{Wk4/l_dist_update.png}
  \caption{Distribution of lengths in box after updating code}
  \label{fig:l_dist_update}
  \end{subfigure}
  \
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth]{Wk4/struct_func_update.png}
  \caption{Log plot of velocity structure function after updating code}
  \label{fig:struct_func_update}
  \end{subfigure}

  \caption{Output of the structure function code for the hydrodynamic $128^3$ forced turbulence simulation}
  \label{fig:structure_plot_update}
  \end{figure}

  Updated the code to calculate the $l_{\|}$ and $l_\perp$ components of the separation vector relative to the magnetic field to observe the critical balance law after a struggle getting it to work. The issue was that selecting the $l$ values based on their angle with the magnetic field was messing up their order, as they were moved to a new array but the code assumed an index correspondence between the velocity data and the $l$ values. Fixed this by using logical masks on both arrays at once to keep the order when performing the MHD calculations. Fig. \ref{fig:l_theta_plots} shows the output of this code on the same $128^3$ simulation as above but with magnetic fields enabled. They are potentially not correct as the parallel components in Fig. \ref{fig:l_par} don't seem to fall off quicker than the perpendicular components. Will check next week.

  \begin{figure}[!h]
   \centering
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth]{Wk4/mhd_cont_turb_128_0.png}
  \caption{Velocity and magnetic structure functions of parallel components}
  \label{fig:l_par}
  \end{subfigure}
  \
  \begin{subfigure}{.4\linewidth}
    \centering
  \includegraphics[width=0.9\linewidth]{Wk4/mhd_cont_turb_128_5.png}
  \caption{Velocity and magnetic structure functions of perpendicular components}
  \label{fig:l_perp}
  \end{subfigure}

  \caption{Output of the structure function code for the MHD $128^3$ forced turbulence simulation}
  \label{fig:l_theta_plots}
  \end{figure}

  Animations of the full structure functions can be found \href{https://github.com/JohnstonZade/python_tools/tree/master/animate}{here}.

  \newpage
  \section*{Week 5: 9 Dec - 13 Dec}

  The previous four weeks I learnt the basics of turbulence and critical balance in fluids and plasmas, and ran and explored some basic hydrodynamic and MHD simulations using Athena to get an idea of what the body of my project will be like. The aim of my project over the summer is the following (not 100\% sure at the moment):

  \textbf{Project Aim:} To look at magneto-immutable turbulence in weakly collisonal plasmas when $|\Delta p|\sim B^2$ using the Braginskii approximation and in different regimes, and to potentially use the results of this to try gain insight into properties of the solar wind?

  The first step is to run the CGL sim at at high collison frequency and compare to the same sim using an adiabatic EOS, as this regime of collison frequency gives back MHD with an adiabatic EOS (allows particle velocities and thus pressure to reach an equilibrium).

  The input file had a $64\times 32\times 32$ grid box with a magnetic field of unit strength along the $x$-axis. Ran these simulations using the HLLE solver and got out a \href{https://github.com/JohnstonZade/python_tools/blob/master/animate/cgl_cont_turb_6432.gif}{CGL structure function} and \href{https://github.com/JohnstonZade/python_tools/blob/master/animate/mhd_cont_turb_6432.gif}{adiabatic MHD structure function}. Note that $\beta = \frac{8\pi p}{B^2} = 1$ in this case. These animations look so similar that I thought I had ran the same simulation twice, but there are subtle differences. This is a good sign as it does output what the theory predicts.

  The next step is to try and obsereve critical balance in the CGL case, and then change the $\beta$ value to $100$. This will run about 10 times as slow but should give similar results.

  After that, will lower the collision frequency and do similar analysis.

\end{document}
